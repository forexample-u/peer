<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Peer chat</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
  }
  #app {
    flex: 1;
    display: flex;
    height: calc(100vh - 50px);
    border-top: 1px solid #333;
  }
  #talkList {
    width: 220px;
    background: #1e1e1e;
    border-right: 1px solid #333;
    overflow-y: auto;
  }
  #talkList h2 {
    margin: 0;
    padding: 15px;
    font-size: 1.1rem;
    border-bottom: 1px solid #333;
    user-select: none;
  }
  .talkItem {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #2c2c2c;
    transition: background 0.2s;
  }
  .talkItem:hover, .talkItem.active {
    background: #3a86ff;
  }
  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #555;
    color: #ddd;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    user-select: none;
  }
  .talkName {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #chatPanel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #171717;
  }
  #chatHeader {
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    font-weight: 600;
    font-size: 1.2rem;
    user-select: none;
    background: #1f1f1f;
    color: #3a86ff;
  }
  #messages {
    flex: 1;
    padding: 15px 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .message {
    max-width: 65%;
    padding: 10px 14px;
    border-radius: 15px;
    font-size: 0.9rem;
    line-height: 1.3;
    word-wrap: break-word;
  }
  .message.from-me {
    background: #2a2a2a; /* 3a86ff, efefef */
    color: #ccc; /* white, black */
    align-self: flex-start; /* flex-end */
    border-bottom-right-radius: 4px;
  }
  .message.from-them {
    background: #2a2a2a;
    color: #ccc;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }
  #messageForm {
    display: flex;
    padding: 12px 16px;
    border-top: 1px solid #333;
    background: #1f1f1f;
  }
  #messageForm input[type="text"] {
    flex: 1;
    padding: 10px 14px;
    border-radius: 20px;
    border: none;
    outline-offset: 2px;
    font-size: 1rem;
    background: #2a2a2a;
    color: #eee;
  }
  #messageForm input[type="text"]::placeholder {
    color: #777;
  }
  #messageForm button {
    margin-left: 12px;
    background: #3a86ff;
    border: none;
    color: white;
    font-weight: 600;
    padding: 0 18px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease;
  }
  #messageForm button:hover {
    background: #265ecf;
  }
  #usernameModal {
    position: fixed;
    inset: 0;
    background: rgba(18,18,18,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  #usernameModalContent {
    background: #1f1f1f;
    padding: 24px 32px;
    border-radius: 12px;
    box-shadow: 0 0 15px #3a86ffaa;
    text-align: center;
  }
  #usernameModalContent h2 {
    margin-bottom: 18px;
    color: #3a86ff;
  }
  #usernameModalContent input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    font-size: 1.1rem;
    outline-offset: 2px;
    background: #2a2a2a;
    color: #eee;
  }
  #usernameModalContent button {
    margin-top: 16px;
    background: #3a86ff;
    border: none;
    color: white;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1rem;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #usernameModalContent button:hover {
    background: #265ecf;
  }
</style>
</head>

<body>
<div id="usernameModal" style="display:none;">
  <div id="usernameModalContent">
    <h2>Username</h2>
    <input type="text" id="usernameModalInput" placeholder="John" maxlength="35" />
    <button id="usernameModalSubmitBtn">Start chat</button>
  </div>
</div>

<div id="app">
  <aside id="talkList">
    <input type="text" id="talkSearchInput" placeholder="Add a talk..." style="
      width: 80%;
      margin: 10px 8px;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      outline-offset: 2px;
      background: #2a2a2a;
      color: #eee;
    " />
    <h2>Talks</h2>
  </aside>
  <section id="chatPanel">
    <div id="chatHeader">Select talk</div>
    <div id="messages"></div>
    <form id="messageForm" autocomplete="off">
      <input type="text" id="messageInput" placeholder="Write a message..." disabled />
      <button type="submit" disabled>Send</button>
    </form>
    <button type="button" id="attachBtn" title="Attach file" style="
        background: #555;
        margin-left: 8px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        display:none;
      " disabled>ðŸ“Ž</button>
      <input type="file" id="fileInput" style="display:none;" />
  </section>
</div>

<script>
  const usernameModal = document.getElementById('usernameModal');
  const usernameModalInput = document.getElementById('usernameModalInput');
  const usernameModalSubmitBtn = document.getElementById('usernameModalSubmitBtn');
  const app = document.getElementById('app');
  const talkListEl = document.getElementById('talkList');
  const talkSearchInput = document.getElementById('talkSearchInput');
  const chatHeader = document.getElementById('chatHeader');
  const messagesEl = document.getElementById('messages');
  const messageForm = document.getElementById('messageForm');
  const attachBtn = document.getElementById('attachBtn');
  const fileInput = document.getElementById('fileInput');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = messageForm.querySelector('button');

  let myColor = localStorage.getItem("myColor") || "";
  let myUsername = localStorage.getItem("myUsername") || "null";
  let selectedTalk = "Select talk";
  let talks = JSON.parse(localStorage.getItem("talks") || '["Open"]');
  let messages = [];
  let host = "https://peertest.liveblog365.com/index.php";
  let interval = 12000;
  setInterval(checkMessages, interval);

  function getRandomColor() {
    const r = Math.floor(Math.random() * 156) + 100;
    const g = Math.floor(Math.random() * 156) + 100;
    const b = Math.floor(Math.random() * 156) + 100;
    const hex = n => n.toString(16).padStart(2, '0');
    return `#${hex(r)}${hex(g)}${hex(b)}`;
  }

  function addStrNumber(str, add) {
    return str.replace(/(\d+)?$/, (m, n) => n ? +n + add : add);
  }

  async function checkMessages() {
    if (selectedTalk == "Select talk") { return; }
    if (document.visibilityState === 'visible')
    {
      let oldLength = messages.length;
      let lastmessageid = "";
      
      sendBtn.disabled = true;
      for (let i = messages.length; ; i++) {
        let messageid = messages.length == 0 ? selectedTalk : addStrNumber(selectedTalk, i);
        if (lastmessageid == messageid) break;
        let text = await getAsync(host, messageid);
        if (text == undefined || text == "" || text == null) break;
        lastmessageid = messageid;
        try {
          text = JSON.parse(text);
        } catch {
            if (text.trim().startsWith('<html') && text.includes('</noscript>')) {
              interval = 10000;
              break; 
            }
        }
        messages.push(text);
        if (i % 5 == 0) {
          renderChat();
        }
      }
      renderChat();
      sendBtn.disabled = false;
      interval = Math.min(interval + 1000, 12000);
      if (oldLength != messages.length) {
        interval = 500;
      }
    }
  }

  async function readMessagesFromUrl(){
    const urlParams = new URLSearchParams(window.location.search);
    const talkId = urlParams.get('talk');
    if (talkId != undefined && talkId != null && talkId != "") {
      selectedTalk = talkId;
      if (!talks.includes(selectedTalk)) {
        talks.push(selectedTalk);
        localStorage.setItem("talks", JSON.stringify(talks));
      }
      renderTalkList();
      await checkMessages();
    }
  }

  function renderTalkList() {
    const list = talkListEl.querySelectorAll('.talkItem').forEach(el => el.remove());
    talks.forEach(talk => {
      const div = document.createElement('div');
      div.className = 'talkItem' + (talk === selectedTalk ? ' active' : '');
      div.dataset.talkname = talk;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = talk.trim().substring(0, 2).toUpperCase();
      const nameDiv = document.createElement('div');
      nameDiv.className = 'talkName';
      nameDiv.textContent = talk;
      div.appendChild(avatar);
      div.appendChild(nameDiv);
      div.onclick = async () => {
        if (talk != selectedTalk) {
          messages = [];
        }
        selectedTalk = talk;
        const url = new URL(window.location);
        url.searchParams.set('talk', selectedTalk);
        window.history.replaceState(null, '', url);
        renderTalkList();
        renderChat();
        await checkMessages();
      };
      talkListEl.appendChild(div);
    });
  }

  function renderChat() {
    if (!selectedTalk) {
      chatHeader.textContent = `Select talk`;
      messagesEl.innerHTML = '';
      messageInput.disabled = true;
      sendBtn.disabled = true;
      return;
    }
    chatHeader.textContent = `${selectedTalk}`;
    messageInput.disabled = false;
    sendBtn.disabled = false;
    messagesEl.innerHTML = '';
    const chatMessages = messages;
    chatMessages.forEach(m => {
      const div = document.createElement('div');
      div.className = 'message ' + (m.from === myUsername ? 'from-me' : 'from-them');
      div.innerHTML = `
        <div style="font-weight:600; font-size:0.8rem; margin-bottom:4px; color: ${m.color};">
          ${m.from === myUsername ? myUsername : m.from}
          <span style="font-weight:400; font-size:0.7rem; color:#999; margin-left:8px;">
            ${new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
          </span>
        </div>
        <div>${m.text == undefined ? m : m.text}</div>
      `;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  document.addEventListener('DOMContentLoaded', async function() {
    if (selectedTalk.length > 0 && myColor.length > 0) {
      messageInput.disabled = true;
      sendBtn.disabled = true;
      await readMessagesFromUrl();
      renderTalkList();
    }
    else {
      app.style = "display:none;";
      usernameModal.style = '';
    }
  });

  talkSearchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const name = talkSearchInput.value.trim();
      if (!talks.includes(name) && name !== myUsername) {
        talks.push(name);
        localStorage.setItem("talks", JSON.stringify(talks));
        renderTalkList();
      }
      talkSearchInput.value = '';
    }
  });

  messageForm.addEventListener('submit', async e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !selectedTalk) return;
    let message = { from: myUsername, to: selectedTalk, text, time: new Date(), color: myColor, isfile: false };
    for (let i = 0; i < 5; i++){
      let number = await writeAsync(host, messages.length == 0 ? selectedTalk : addStrNumber(selectedTalk, messages.length + i), JSON.stringify(message));
      if (number > 0) break;
    }
    await checkMessages();
    renderChat();
    messageInput.value = '';
  });

  usernameModalSubmitBtn.onclick = async () => {
    const username = usernameModalInput.value.trim();
    if (!username) {
      usernameModalInput.focus();
      return;
    }
    myUsername = username;
    myColor = getRandomColor();
    selectedTalk = "Select talk";
    usernameModal.style.display = 'none';
    app.style.display = 'flex';
    renderTalkList();
    renderChat();
    localStorage.setItem("myUsername", myUsername);
    localStorage.setItem("myColor", myColor);
    await readMessagesFromUrl();
  };

  usernameModalInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') usernameModalSubmitBtn.click();
  });

  async function writeAsync(url, id, text, file = null) {
    const formData = new FormData();
    formData.append('text', text);
    if (file) {
      formData.append('file', file, file.name);
    }
    const response = await fetch(`${url}/peer/write/${id}`, { method: 'POST', body: formData });
    return Number(await response.text());
  }

  async function getAsync(url, id) {
    const response = await fetch(`${url}/peer/text/${id}`);
    return await response.text();
  }
</script>
</body>
</html>